<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spot the Difference ‚Äî Snapshots</title>
  <style>
    :root { color-scheme: dark; --bg:#0b0d10; --panel:#10141b; --line:#1e2733; --txt:#e7ecef; --muted:#9fb3c8; }
    html,body{height:100%}
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:var(--bg); color:var(--txt); display:flex; flex-direction:column; }
    header { position:sticky; top:0; z-index:5; background:rgba(16,20,27,.85); backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--line); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 1.15rem; margin:0; }
    main { flex:1; }
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px; }
    .grid { display:grid; gap:16px; }
    .grid-2 { grid-template-columns:1fr; }
    @media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { background:#1a2433; border:1px solid #2a374a; color:var(--txt); padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn:hover { background:#22314a; }
    .btn.ghost { background:transparent; }
    .muted { color:var(--muted); }
    .list { display:grid; gap:10px; }
    .item { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:#0f131a; }
    a.item { color:inherit; text-decoration:none; }
    .pill { padding:6px 10px; border:1px solid var(--line); border-radius:999px; font-size:.8rem; color:var(--muted); }
    video, img, canvas { width:100%; border-radius:12px; background:#0b0f15; }
    footer { text-align:center; color:#7f8da0; padding:16px; }
    .cta { display:flex; gap:12px; align-items:center; }
    .danger { color:#ff7b7b; }
    .ok { color:#8dff9b; }
    .spacer { height:8px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>üì∏ Spot the Difference</h1>
      <span class="pill">Local only</span>
      <span id="hdrStatus" class="muted" style="margin-left:auto"></span>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME VIEW -->
    <section id="view-home" class="grid">
      <div class="panel">
        <h2>Create snapshot</h2>
        <p class="muted">Capture a baseline photo. It‚Äôll be saved locally and appear below.</p>
        <div class="grid-2 grid">
          <div>
            <video id="homeVideo" playsinline autoplay muted></video>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn" id="btnCreateSnapshot">Create Snapshot</button>
              <label class="btn ghost" for="homeUpload">Upload instead</label>
              <input id="homeUpload" class="hidden" type="file" accept="image/*" capture="environment" />
              <button class="btn ghost" id="btnRestartCamHome">Restart Camera</button>
            </div>
            <p id="homeHint" class="muted"></p>
          </div>
          <div>
            <canvas id="homePreview"></canvas>
            <p class="muted">Last captured frame preview.</p>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Snapshots</h2>
        <div id="emptyState" class="muted">No snapshots yet. Create one above.</div>
        <div id="snapshotList" class="list"></div>
      </div>
    </section>

    <!-- DETAIL VIEW -->
    <section id="view-detail" class="grid hidden">
      <div class="panel">
        <button class="btn ghost" id="btnBack">‚Üê Back</button>
        <h2 id="detailTitle">Snapshot</h2>
        <p class="muted">Baseline preview:</p>
        <img id="baselineImg" alt="Baseline preview" />
        <div class="spacer"></div>
        <div class="cta">
          <button class="btn" id="btnCompare">Compare</button>
          <label class="btn ghost" for="detailUpload">Upload instead</label>
          <input id="detailUpload" class="hidden" type="file" accept="image/*" capture="environment" />
          <button class="btn ghost" id="btnRestartCamDetail">Restart Camera</button>
        </div>
        <p id="detailHint" class="muted"></p>
        <video id="detailVideo" class="hidden" playsinline autoplay muted></video>
      </div>

      <div class="panel">
        <h3>Result</h3>
        <p class="muted">After taking a new photo, this area flips between baseline and the new photo every second.</p>
        <img id="flipView" alt="Flip view" />
        <div class="spacer"></div>
        <div class="row">
          <button class="btn" id="btnStartFlip" disabled>Start Flip</button>
          <button class="btn ghost" id="btnStopFlip" disabled>Stop</button>
          <span id="flipStatus" class="muted"></span>
        </div>
      </div>
    </section>
  </main>

  <footer>All data is stored in your browser (IndexedDB). Nothing is uploaded.</footer>

  <script>
  /************ IndexedDB (snapshots store) ************/
  const DB_NAME='spotdiff-db-v2';
  const STORE='snapshots';
  function dbOpen(){
    return new Promise((res,rej)=>{
      const req=indexedDB.open(DB_NAME,2);
      req.onupgradeneeded=()=> {
        const db=req.result;
        if(!db.objectStoreNames.contains(STORE)){
          const os=db.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
          os.createIndex('createdAt','createdAt');
        }
      };
      req.onsuccess=()=>res(req.result);
      req.onerror=()=>rej(req.error);
    });
  }
  async function dbAddSnapshot(snap){ const db=await dbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).add(snap).onsuccess=e=>res(e.target.result); tx.onerror=()=>rej(tx.error); }); }
  async function dbListSnapshots(){ const db=await dbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).getAll(); req.onsuccess=()=>res(req.result.sort((a,b)=>b.createdAt-a.createdAt)); req.onerror=()=>rej(req.error); }); }
  async function dbGetSnapshot(id){ const db=await dbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(Number(id)); req.onsuccess=()=>res(req.result||null); req.onerror=()=>rej(req.error); }); }

  /************ Utilities ************/
  const $=sel=>document.querySelector(sel);
  const fmtDate=ms=>new Date(ms).toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  function drawToCanvas(img, canvas, maxW=1400){ const ctx=canvas.getContext('2d'); const scale=Math.min(1, maxW/img.width); canvas.width=Math.round(img.width*scale); canvas.height=Math.round(img.height*scale); ctx.drawImage(img,0,0,canvas.width,canvas.height); }
  function loadDataUrl(url){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }
  function dataUrlFromVideo(video){ const w=video.videoWidth||1280,h=video.videoHeight||720; const c=document.createElement('canvas'); const maxW=1400, scale=Math.min(1,maxW/w); c.width=Math.round(w*scale); c.height=Math.round(h*scale); c.getContext('2d').drawImage(video,0,0,c.width,c.height); return c.toDataURL('image/jpeg',0.92); }

  async function startCamera(elVideo){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false });
      elVideo.classList.remove('hidden');
      elVideo.srcObject=stream; await elVideo.play();
      setHdr('Camera ready.');
    }catch(e){
      setHdr('Camera unavailable. Use Upload instead.');
    }
  }
  function stopCamera(elVideo){
    try{ elVideo.srcObject?.getTracks().forEach(t=>t.stop()); }catch{}
    elVideo.srcObject=null;
  }
  function setHdr(msg){ $('#hdrStatus').textContent=msg; }
  function setHint(el,msg){ el.textContent=msg; }

  /************ Simple hash router ************/
  function goHome(){ location.hash='#/'; }
  function goDetail(id){ location.hash=`#/snapshot/${id}`; }
  function parseRoute(){
    const h=location.hash||'#/'; const m=h.match(/^#\/snapshot\/(\d+)/);
    return m?{view:'detail', id:Number(m[1])}:{view:'home'};
  }

  /************ State ************/
  let homeLastDataUrl=null;
  let flipTimer=null;
  let currentDetail=null; // { id, createdAt, dataUrl }
  let compareDataUrl=null;

  /************ DOM refs ************/
  const viewHome = $('#view-home');
  const viewDetail = $('#view-detail');
  const homeVideo = $('#homeVideo');
  const homeUpload = $('#homeUpload');
  const homePreview = $('#homePreview');
  const homeHint = $('#homeHint');
  const btnCreateSnapshot = $('#btnCreateSnapshot');
  const btnRestartCamHome = $('#btnRestartCamHome');
  const listEl = $('#snapshotList');
  const emptyState = $('#emptyState');

  const btnBack = $('#btnBack');
  const detailTitle = $('#detailTitle');
  const baselineImg = $('#baselineImg');
  const detailVideo = $('#detailVideo');
  const detailUpload = $('#detailUpload');
  const btnCompare = $('#btnCompare');
  const btnRestartCamDetail = $('#btnRestartCamDetail');
  const detailHint = $('#detailHint');

  const flipView = $('#flipView');
  const btnStartFlip = $('#btnStartFlip');
  const btnStopFlip = $('#btnStopFlip');
  const flipStatus = $('#flipStatus');

  /************ Home view logic ************/
  async function refreshList(){
    const snaps = await dbListSnapshots();
    listEl.innerHTML='';
    if(!snaps.length){ emptyState.classList.remove('hidden'); return; }
    emptyState.classList.add('hidden');
    for(const s of snaps){
      const a=document.createElement('a');
      a.href=`#/snapshot/${s.id}`;
      a.className='item';
      a.innerHTML=`<span>üìå Snapshot <strong>#${s.id}</strong></span><span class="muted">${fmtDate(s.createdAt)}</span>`;
      listEl.appendChild(a);
    }
  }
  async function showHome(){
    viewHome.classList.remove('hidden');
    viewDetail.classList.add('hidden');
    await startCamera(homeVideo);
    refreshList();
    setHint(homeHint,'Tap ‚ÄúCreate Snapshot‚Äù to save the current frame.');
  }
  function hideHome(){ stopCamera(homeVideo); }

  btnCreateSnapshot.addEventListener('click', async ()=>{
    if (!homeLastDataUrl){
      if (homeVideo.readyState>=2 && homeVideo.videoWidth){
        homeLastDataUrl = dataUrlFromVideo(homeVideo);
        const img = await loadDataUrl(homeLastDataUrl);
        drawToCanvas(img, homePreview);
      } else {
        setHint(homeHint,'Camera not ready. Use Upload instead.');
        return;
      }
    }
    const id = await dbAddSnapshot({ createdAt: Date.now(), dataUrl: homeLastDataUrl });
    homeLastDataUrl = null;
    homePreview.getContext('2d')?.clearRect(0,0,homePreview.width,homePreview.height);
    await refreshList();
    goDetail(id);
  });

  homeUpload.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=async ()=>{
      homeLastDataUrl = reader.result;
      const img = await loadDataUrl(homeLastDataUrl);
      drawToCanvas(img, homePreview);
      setHint(homeHint,'Looks good. Tap ‚ÄúCreate Snapshot‚Äù to save it.');
    };
    reader.readAsDataURL(f);
  });

  btnRestartCamHome.addEventListener('click', ()=>{ stopCamera(homeVideo); startCamera(homeVideo); });

  /************ Detail view logic ************/
  async function showDetail(id){
    viewHome.classList.add('hidden');
    viewDetail.classList.remove('hidden');
    currentDetail = await dbGetSnapshot(id);
    if(!currentDetail){ detailTitle.textContent='Snapshot not found'; baselineImg.src=''; return; }
    detailTitle.textContent = `Snapshot #${currentDetail.id} ‚Äî ${fmtDate(currentDetail.createdAt)}`;
    baselineImg.src = currentDetail.dataUrl;
    compareDataUrl = null;
    btnStartFlip.disabled = true; btnStopFlip.disabled = true; flipStatus.textContent='';
    await startCamera(detailVideo); // hidden until Compare is pressed
    setHint(detailHint,'Press ‚ÄúCompare‚Äù to take a new photo with the camera.');
  }
  function hideDetail(){
    stopCamera(detailVideo);
    stopFlip();
    compareDataUrl = null;
  }

  btnBack.addEventListener('click', ()=> goHome());

  btnRestartCamDetail.addEventListener('click', ()=>{ stopCamera(detailVideo); startCamera(detailVideo); });

  detailUpload.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=async ()=>{
      compareDataUrl = reader.result;
      await startFlipIfReady();
    };
    reader.readAsDataURL(f);
  });

  btnCompare.addEventListener('click', async ()=>{
    if (detailVideo.readyState>=2 && detailVideo.videoWidth){
      compareDataUrl = dataUrlFromVideo(detailVideo);
      await startFlipIfReady();
    } else {
      setHint(detailHint,'Camera not ready. Use Upload instead.');
    }
  });

  async function startFlipIfReady(){
    if (!currentDetail?.dataUrl || !compareDataUrl) return;
    // Normalize both images to same display size for a clean flip
    const baseImg = await loadDataUrl(currentDetail.dataUrl);
    const newImg = await loadDataUrl(compareDataUrl);

    // Choose a target width (the smaller of the two)
    const targetW = Math.min(baseImg.width, newImg.width, 1400);
    // Render both to canvases at the same size and get compact dataURLs
    async function normalize(img){
      const c=document.createElement('canvas'); const scale=Math.min(1, targetW/img.width);
      c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      return c.toDataURL('image/jpeg',0.9);
    }
    const [normBase, normNew] = await Promise.all([normalize(baseImg), normalize(newImg)]);
    currentDetail._normBase = normBase;
    compareDataUrl = normNew;

    flipView.src = currentDetail._normBase;
    btnStartFlip.disabled = false;
    btnStopFlip.disabled = false;
    flipStatus.textContent='Ready. Press ‚ÄúStart Flip‚Äù.';
  }

  function startFlip(){
    if (flipTimer) return;
    let showBase=true;
    flipView.src = showBase ? currentDetail._normBase : compareDataUrl;
    flipStatus.textContent='Flipping every 1s‚Ä¶';
    flipTimer = setInterval(()=>{
      showBase = !showBase;
      flipView.src = showBase ? currentDetail._normBase : compareDataUrl;
    }, 1000);
  }
  function stopFlip(){
    if (flipTimer){ clearInterval(flipTimer); flipTimer=null; flipStatus.textContent='Stopped.'; }
  }
  btnStartFlip.addEventListener('click', startFlip);
  btnStopFlip.addEventListener('click', stopFlip);

  /************ Router boot ************/
  window.addEventListener('hashchange', ()=>{
    const r=parseRoute();
    hideHome(); hideDetail();
    if(r.view==='home') showHome(); else showDetail(r.id);
  });

  // First load
  (async function init(){
    const r=parseRoute();
    if(r.view==='home'){ await showHome(); } else { await showDetail(r.id); }
  })();
  </script>
</body>
</html>
